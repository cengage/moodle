{"version":3,"file":"deeplinking.min.js","sources":["../src/deeplinking.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty omf\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @package    tiny_lti\n * @copyright  Claude Vervoort Cengage Group <claude.vervoort@cengage.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport {get_string as getString} from 'core/str';\nimport {component} from './common';\nimport * as Modal from 'core/modal_factory';\nimport * as ModalEvents from 'core/modal_events';\nimport {getStartUrl} from './options';\n\n/**\n * @typedef ProblemDetail\n * @type {object}\n * @param {string} description The description of the problem\n * @param {ProblemNode[]} problemNodes The list of affected nodes\n */\n\n/**\n * @typedef ProblemNode\n * @type {object}\n * @param {string} nodeName The node name for the affected node\n * @param {string} nodeIndex The indexd of the node\n * @param {string} text A description of the issue\n * @param {string} src The source of the image\n */\n\nexport default class {\n\n    constructor(editor) {\n        this.editor = editor;\n        this.modal = null;\n        this.callback = 'dlr'+Math.floor(Math.random() * 9999999);\n        document.CALLBACKS = document.CALLBACKS || {};\n    }\n\n    destroy() {\n        delete this.editor;\n        delete document.CALLBACKS[this.callback];\n        this.modal.destroy();\n        delete this.modal;\n    }\n\n    async displayDialogue() {\n        const startUrl = getStartUrl(this.editor) + `&callback=${this.callback}`;\n        this.modal = await Modal.create({\n            type: Modal.types.DEFAULT,\n            large: true,\n            title: getString('pluginname', component),\n            body: this.getDialogueContent(startUrl)\n        });\n        // Destroy the class when hiding the modal.\n        this.modal.getRoot().on(ModalEvents.hidden, () => this.destroy());\n\n        this.modal.getRoot()[0].addEventListener('click', (event) => {\n            const faultLink = event.target.closest('[data-action=\"highlightfault\"]');\n            if (!faultLink) {\n                return;\n            }\n\n            event.preventDefault();\n\n            const nodeName = faultLink.dataset.nodeName;\n            let selectedNode = null;\n            if (nodeName) {\n                if (nodeName.includes(',') || nodeName === 'body') {\n                    selectedNode = this.editor.dom.select('body')[0];\n                } else {\n                    const nodeIndex = faultLink.dataset.nodeIndex ?? 0;\n                    selectedNode = this.editor.dom.select(nodeName)[nodeIndex];\n                }\n            }\n\n            if (selectedNode && selectedNode.nodeName.toUpperCase() !== 'BODY') {\n                this.selectAndScroll(selectedNode);\n            }\n\n            this.modal.hide();\n        });\n\n        document.CALLBACKS[this.callback] = (response) => {\n            var items = response.items || [];\n            items.forEach(i=>this.addToEditor(i));\n            this.modal.hide();\n        };\n        this.modal.show();\n    }\n\n\n    /**\n     * Return the dialogue content.\n     * @param {string} startUrl URL to start the deeplinking flow\n     *\n     * @return {Promise<Array>} A template promise containing the rendered dialogue content.\n     */\n     async getDialogueContent(startUrl) {\n\n        return Templates.render('tiny_lti/deeplinking', {\n            startUrl\n        });\n    }\n\n    /**\n     * Adds the LTI link to the editor\n     * @param {object} item content item to add\n     */\n    addToEditor(item) {\n        if (item.mediaType === 'application/vnd.ims.lti.v1.ltilink') {\n            var mode = \"embed\";\n            var windowTarget = \"_blank\";\n            if (item.placementAdvice) {\n                switch (item.placementAdvice.presentationDocumentTarget) {\n                    case 'window':\n                    case 'popup':\n                    case 'overlay':\n                        mode = \"window\";\n                        windowTarget = item.placementAdvice.windowTarget || windowTarget;\n                        break;\n                }\n            }\n            var width = (item.placementAdvice && item.placementAdvice.displayWidth) ?\n                parseInt(item.placementAdvice.displayWidth) : 800;\n            var height = (item.placementAdvice && item.placementAdvice.displayWidth) ?\n                parseInt(item.placementAdvice.displayHeight) : Math.floor(width / 4 * 3);\n            // sanitize target, url, text\n            this.editor.insertContent(`<a href=\"${item.ltiurl}\"\n                data-lti=\"${mode};width:${width}px;height:${height}px\"\n                target=\"${windowTarget}\">${item.text}</a>`);\n        } else if (item.mediaType === 'text/html') {\n            if (item.embed && item.embed.html) {\n                this.editor.insertContent(item.embed.html);\n            }\n            if (item.url) {\n                const target = (item.window && item.window.targetName) || '_blank';\n                this.editor.insertContent(`<a href='${item.url}' target='${target}'>${item.text || item.title || ''}</a>`);\n            } else {\n                this.editor.insertContent(item.text);\n            }\n        } else if (item.mediaType.startsWith('image/')) {\n            this.editor.insertContent(`<img src='${item.url}' alt='${item.title || ''}'>`);\n        }\n    }\n\n}"],"names":["constructor","editor","modal","callback","Math","floor","random","document","CALLBACKS","destroy","this","startUrl","Modal","create","type","types","DEFAULT","large","title","component","body","getDialogueContent","getRoot","on","ModalEvents","hidden","addEventListener","event","faultLink","target","closest","preventDefault","nodeName","dataset","selectedNode","includes","dom","select","nodeIndex","toUpperCase","selectAndScroll","hide","response","items","forEach","i","addToEditor","show","Templates","render","item","mediaType","mode","windowTarget","placementAdvice","presentationDocumentTarget","width","displayWidth","parseInt","height","displayHeight","insertContent","ltiurl","text","embed","html","url","window","targetName","startsWith"],"mappings":";;;;;8rCA8CIA,YAAYC,aACHA,OAASA,YACTC,MAAQ,UACRC,SAAW,MAAMC,KAAKC,MAAsB,QAAhBD,KAAKE,UACtCC,SAASC,UAAYD,SAASC,WAAa,GAG/CC,iBACWC,KAAKT,cACLM,SAASC,UAAUE,KAAKP,eAC1BD,MAAMO,iBACJC,KAAKR,oCAINS,UAAW,wBAAYD,KAAKT,4BAAuBS,KAAKP,eACzDD,YAAcU,MAAMC,OAAO,CAC5BC,KAAMF,MAAMG,MAAMC,QAClBC,OAAO,EACPC,OAAO,mBAAU,aAAcC,mBAC/BC,KAAMV,KAAKW,mBAAmBV,iBAG7BT,MAAMoB,UAAUC,GAAGC,YAAYC,QAAQ,IAAMf,KAAKD,iBAElDP,MAAMoB,UAAU,GAAGI,iBAAiB,SAAUC,cACzCC,UAAYD,MAAME,OAAOC,QAAQ,sCAClCF,iBAILD,MAAMI,uBAEAC,SAAWJ,UAAUK,QAAQD,aAC/BE,aAAe,QACfF,YACIA,SAASG,SAAS,MAAqB,SAAbH,SAC1BE,aAAexB,KAAKT,OAAOmC,IAAIC,OAAO,QAAQ,OAC3C,iCACGC,wCAAYV,UAAUK,QAAQK,iEAAa,EACjDJ,aAAexB,KAAKT,OAAOmC,IAAIC,OAAOL,UAAUM,WAIpDJ,cAAwD,SAAxCA,aAAaF,SAASO,oBACjCC,gBAAgBN,mBAGpBhC,MAAMuC,UAGflC,SAASC,UAAUE,KAAKP,UAAauC,YACrBA,SAASC,OAAS,IACxBC,SAAQC,GAAGnC,KAAKoC,YAAYD,UAC7B3C,MAAMuC,aAEVvC,MAAM6C,gCAUWpC,iBAEfqC,mBAAUC,OAAO,uBAAwB,CAC5CtC,SAAAA,WAQRmC,YAAYI,SACe,uCAAnBA,KAAKC,UAAoD,KACrDC,KAAO,QACPC,aAAe,YACfH,KAAKI,uBACGJ,KAAKI,gBAAgBC,gCACpB,aACA,YACA,UACDH,KAAO,SACPC,aAAeH,KAAKI,gBAAgBD,cAAgBA,iBAI5DG,MAASN,KAAKI,iBAAmBJ,KAAKI,gBAAgBG,aACtDC,SAASR,KAAKI,gBAAgBG,cAAgB,IAC9CE,OAAUT,KAAKI,iBAAmBJ,KAAKI,gBAAgBG,aACvDC,SAASR,KAAKI,gBAAgBM,eAAiBxD,KAAKC,MAAMmD,MAAQ,EAAI,QAErEvD,OAAO4D,iCAA0BX,KAAKY,+CAC3BV,uBAAcI,2BAAkBG,+CAClCN,0BAAiBH,KAAKa,mBACjC,GAAuB,cAAnBb,KAAKC,aACRD,KAAKc,OAASd,KAAKc,MAAMC,WACpBhE,OAAO4D,cAAcX,KAAKc,MAAMC,MAErCf,KAAKgB,IAAK,OACJrC,OAAUqB,KAAKiB,QAAUjB,KAAKiB,OAAOC,YAAe,cACrDnE,OAAO4D,iCAA0BX,KAAKgB,yBAAgBrC,oBAAWqB,KAAKa,MAAQb,KAAKhC,OAAS,sBAE5FjB,OAAO4D,cAAcX,KAAKa,WAE5Bb,KAAKC,UAAUkB,WAAW,gBAC5BpE,OAAO4D,kCAA2BX,KAAKgB,sBAAahB,KAAKhC,OAAS"}